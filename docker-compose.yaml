services:
  # ============================================
  # MESSAGING LAYER - Apache Kafka
  # ============================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 10

  # ============================================
  # BATCH LAYER - Apache Hive + Metastore
  # ============================================
  postgres:
    image: postgres:13
    container_name: postgres
    environment:
      POSTGRES_USER: hive
      POSTGRES_PASSWORD: hive
      POSTGRES_DB: metastore
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hive -d metastore"]
      interval: 10s
      timeout: 5s
      retries: 5

  hive-metastore:
    image: apache/hive:3.1.3
    container_name: hive-metastore
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SERVICE_NAME: metastore
      DB_DRIVER: postgres
      SERVICE_OPTS: "-Djavax.jdo.option.ConnectionDriverName=org.postgresql.Driver -Djavax.jdo.option.ConnectionURL=jdbc:postgresql://postgres:5432/metastore -Djavax.jdo.option.ConnectionUserName=hive -Djavax.jdo.option.ConnectionPassword=hive"
    ports:
      - "9083:9083"
    volumes:
      - ./data/hive:/opt/hive/data
      - ./data/parquet:/opt/hive/parquet
      - ./data/avro:/opt/hive/avro

  hive-server:
    image: apache/hive:3.1.3
    container_name: hive-server
    depends_on:
      - hive-metastore
    environment:
      SERVICE_NAME: hiveserver2
      SERVICE_OPTS: "-Dhive.metastore.uris=thrift://hive-metastore:9083"
      IS_RESUME: "true"
    ports:
      - "10000:10000"
      - "10002:10002"
    volumes:
      - ./data/hive:/opt/hive/data
      - ./data/parquet:/opt/hive/parquet
      - ./data/avro:/opt/hive/avro

  # ============================================
  # SPEED LAYER - Apache Spark
  # ============================================
  spark-master:
    image: apache/spark:3.5.0
    container_name: spark-master
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master
    environment:
      - SPARK_MASTER_HOST=spark-master
    ports:
      - "8085:8080"
      - "7077:7077"
    volumes:
      - ./model:/opt/spark/work/model
      - ./data:/opt/spark/work/data

  spark-worker:
    image: apache/spark:3.5.0
    container_name: spark-worker
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077
    depends_on:
      - spark-master
    environment:
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_CORES=2
    volumes:
      - ./model:/opt/spark/work/model
      - ./data:/opt/spark/work/data

  # ============================================
  # ORCHESTRATION - Apache Airflow
  # ============================================
  airflow:
    image: apache/airflow:2.7.3-python3.10
    container_name: airflow
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////opt/airflow/airflow.db
      - AIRFLOW__CORE__FERNET_KEY=your-fernet-key-here-must-be-32-bytes
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__WEBSERVER__SECRET_KEY=your-secret-key
      - _PIP_ADDITIONAL_REQUIREMENTS=kafka-python pandas pyarrow fastavro
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins
      - ./data:/opt/airflow/data
      - ./model:/opt/airflow/model
    ports:
      - "8081:8080"
    command: >
      bash -c "
        airflow db init &&
        airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || true &&
        airflow webserver -p 8080 &
        airflow scheduler
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================
  # ML PLATFORM - Apache Submarine
  # ============================================
  submarine-database:
    image: mysql:8.0
    container_name: submarine-database
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: submarine
      MYSQL_USER: submarine
      MYSQL_PASSWORD: submarine
    volumes:
      - submarine_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      interval: 10s
      timeout: 5s
      retries: 5

  submarine-server:
    image: apache/submarine:0.8.0
    container_name: submarine-server
    depends_on:
      submarine-database:
        condition: service_healthy
    environment:
      SUBMARINE_SERVER_DATABASE_URL: jdbc:mysql://submarine-database:3306/submarine?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&failOverReadOnly=false&useSSL=false&allowPublicKeyRetrieval=true
      SUBMARINE_SERVER_DATABASE_USERNAME: submarine
      SUBMARINE_SERVER_DATABASE_PASSWORD: submarine
    ports:
      - "8080:8080"
    volumes:
      - ./model:/opt/submarine/model
      - ./data:/opt/submarine/data
    command: >
      bash -c "
        /opt/submarine/bin/submarine-daemon.sh start getMysqlJar &&
        /opt/submarine/bin/submarine-daemon.sh start server
      "

  submarine-mlflow:
    image: apache/submarine:0.8.0-mlflow
    container_name: submarine-mlflow
    depends_on:
      - submarine-database
    environment:
      BACKEND_STORE_URI: mysql+pymysql://submarine:submarine@submarine-database:3306/submarine
    ports:
      - "5001:5000"
    volumes:
      - ./model:/mlflow/artifacts

volumes:
  postgres_data:
  submarine_mysql_data:
